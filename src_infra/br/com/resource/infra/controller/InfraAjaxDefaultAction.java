/* Resource Tecnologia
 * Copyright (c) 2007 - Todos os direitos reservados
 *
 *   .: Projeto.....Infraestrutura para aplicativos Java
 *   .: Objeto......InfraAjaxDefaultAction.java
 *   .: Criação.....20 de março, 13:22
 *   .: Autor.......Thiago Uriel M. Garcia
 *   .: Descrição...Classe básica para actions do Struts, com suporte ao Ajax.
 */
package br.com.resource.infra.controller;

import java.io.PrintWriter;
import java.io.StringWriter;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;
import org.springframework.web.context.WebApplicationContext;
import org.springframework.web.struts.ActionSupport;

import br.com.resource.infra.exception.ControllerException;

/** Action que retorna resultados de requisições que esperam
 *  respostas em <b>Ajax</b>.
 *  <p>
 *  Esta action não retorna <i>forwards</i>, estes serão sempre
 *  nulos. Sua função é criar um XML de resposta através de suas 
 *  classes filhas, e escrevê-lo na saída.
 *  <p>
 *  Cada action filha deverá sobrescrever o método abstrato
 *  <code>getXmlContent</code>, retornando uma String de resposta.
 *  
 *  @author Thiago Uriel M. Garcia
 */
public abstract class InfraAjaxDefaultAction extends ActionSupport {
	
	/** Armazena o contexto da aplicação para que as actions filhas
     *  possam utilizar beans instanciados pelo Spring.
     */
    protected WebApplicationContext springContext;

	/** Adiciona mensagens de erro ao request para que sejam
	 *  apresentadas por uma tela de erro ao usuário.
	 *  
	 *  @param e
	 *  	Exception recebida, a ser incluida ao Request.
	 *  @param request
	 *		Requisição que irá receber o erro.  	
	 */
	protected void addException(Exception e, HttpServletRequest request) {
		
		request.setAttribute("error.exception", e);

		StringWriter strWriter = new StringWriter();
		PrintWriter writer = new PrintWriter(strWriter);
		e.printStackTrace(writer);
		writer.flush();
		writer.close();
		
		request.setAttribute("error.stackTrace", strWriter.getBuffer().toString());
		request.setAttribute("error.message", e.getMessage());
		
	}
	
	/** Salva informações do erro ocorrido e retorna o forward 
	 *  para a página de exibição do erro.
	 * 
	 *  @param msg Exceção
	 *  @param request Request
	 *  @return Forward para a página de erro
	 */
	protected void addException(String msg, HttpServletRequest request) {
		
		request.setAttribute("error.message", msg);
		
	}	
	
	/** Método de entrada da action. Envia a requisição para o
	 *  método <code>doTask</code> implementado nas actions filhas.
	 * 
	 *  @param mapping
	 *      O objeto <code>ActionMapping</code> utilizado para
	 *      selecionar esta instância.
	 *  @param form
	 *      Um objeto (opcional) do tipo <code>ActionForm</code>
	 *      utilizado nesta requisição.
	 *  @param request
	 *      A requisição <code>HTTP</code> que estamos processando.
	 *  @param response
	 *      A resposta <code>HTTP</code> que estamos processando.
	 * 
	 *  @return 
	 *  	Um objeto <code>ActionForward</code> determinando para onde o
	 *      <i>framework</i> deverá despachar a requisição.
	 * 
	 *  @throws Exception
	 *		Se houverem erros, estes serão lançados como uma exception
	 *      deste tipo.
	 */
	public ActionForward execute(ActionMapping mapping
			                   , ActionForm form
			                   , HttpServletRequest request
			                   , HttpServletResponse response) throws Exception {

        // Disponibilizamos o contexto da aplicação para action.
        this.springContext = super.getWebApplicationContext();        
        
		// Bloqueio do cache da página.
		response.setHeader("Pragma","no-cache");
		response.setHeader("Cache-Control", "no-store,no-cache,must-revalidate");
		response.setDateHeader("Expires" , -1);
		
		// Chamamos o método abstrado doTask que deverá ser implementado
		// por todas as actions do sistema.
		try {

			return this.doTask( mapping, form, request, response );
			
		} catch ( ControllerException cExp ) {
			
            addException( cExp, request );
			return mapping.findForward( "errorPage" );
			
		}
		
	}
	
	/** Chama o método abstrado das classes filhas que cria o XML
	 *  de resposta e com esta resposta, envia os dados ao cliente.
	 *  
	 *  @param mapping
	 *  	O objeto <code>ActionMapping</code> utilizado para
	 *      selecionar esta instância.
	 *  @param form
	 *      Um objeto (opcional) do tipo <code>ActionForm</code>
	 *      utilizado nesta requisição.
	 *  @param request
	 *      A requisição <code>HTTP</code> que estamos processando.
	 *  @param response
	 *      A resposta <code>HTTP</code> que estamos processando.
	 * 
	 *  @return 
	 *  	Um objeto <code>ActionForward</code> determinando para onde 
	 *  	o <i>framework</i> deverá despachar a requisição. Como este
	 *  	tipo de action deverá retornar a resposta ao client, contendo
	 *  	um XML e isso não será uma tela, a resposta sempre será nula
	 *  	e o conteúdo do Ajax será retornado via <code>PrintWriter</code>.
	 * 
	 *  @throws ControllerException
	 *  	Se houverem erros, estes serão lançados como uma exception
	 *      deste tipo.
	 */	
	public ActionForward doTask( ActionMapping mapping
			  			       , ActionForm form
							   , HttpServletRequest request
							   , HttpServletResponse response) throws ControllerException {
		
		String xml = null;
	    
	    try {
	    	
	    	xml = getXmlContent( mapping, form, request, response );
	      
			// Determinamos que o conteúdo será XML.
			response.setContentType("text/xml; charset=UTF-8");
			PrintWriter pw = response.getWriter();
			pw.write( xml );
			pw.close();
			
			return null;	      
	      
	    } catch ( Exception exp ) {

	    	throw new ControllerException( exp );
	      
	    }

	}
	
	/** Cada classe filha deverá sobrescrever este método para gerar a resposta XML
	 *  esperada por cada requisição do Ajax.
	 *  
	 *  @param mapping
	 *  	O objeto <code>ActionMapping</code> utilizado para
	 *      selecionar esta instância.
	 *  @param form
	 *      Um objeto (opcional) do tipo <code>ActionForm</code>
	 *      utilizado nesta requisição.
	 *  @param request
	 *      A requisição <code>HTTP</code> que estamos processando.
	 *  @param response
	 *      A resposta <code>HTTP</code> que estamos processando.
	 * 
	 *  @return 
     *      Uma String com o conteúdo XML (ou texto) a ser enviado
     *      de volta ao cliente.

	 * 
	 *  @throws ControllerException
	 *  	Se houverem erros, estes serão lançados como uma exception
	 *      deste tipo.
	 */		  
	public abstract String getXmlContent( ActionMapping mapping
										, ActionForm form
										, HttpServletRequest request
										, HttpServletResponse response) throws ControllerException;	
	
}